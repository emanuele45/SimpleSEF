<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- ***** BEGIN LICENSE BLOCK *****
   - Version: MPL 1.1
   -
   - The contents of this file are subject to the Mozilla Public License Version
   - 1.1 (the "License"); you may not use this file except in compliance with
   - the License. You may obtain a copy of the License at
   - http://www.mozilla.org/MPL/
   -
   - Software distributed under the License is distributed on an "AS IS" basis,
   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
   - for the specific language governing rights and limitations under the
   - License.
   -
   - The Original Code is http://code.mattzuba.com code.
   -
   - The Initial Developer of the Original Code is
   - Matt Zuba.
   - Portions created by the Initial Developer are Copyright (C) 2010-2011
   - the Initial Developer. All Rights Reserved.
   -
   - Contributor(s):
   -
   - ***** END LICENSE BLOCK ***** -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>slammeddime:simplesef</id>
	<version>2.1</version>
	<file name="$sourcedir/ModSettings.php">
		<operation>
			<search position="after"><![CDATA[	);

	// By default do the basic settings.
]]></search>
			<add><![CDATA[		'simplesef' => 'ModifySimpleSEFSettings',
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[			'layout' => array(
				'title' => $txt['mods_cat_layout'],
				'href' => $scripturl . '?action=featuresettings;sa=layout;sesc=' . $context['session_id'],
			),
]]></search>
			<add><![CDATA[			'simplesef' => array(
				'title' => $txt['simplesef'],
				'description' => $txt['simplesef_desc'],
				'href' => $scripturl . '?action=featuresettings;sa=simplesef;sesc=' . $context['session_id'],
			),
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[	);

	// Default to core (I assume)
]]></search>
			<add><![CDATA[		'simplesef' => 'ModifySimpleSEFSettings',
]]></add>
		</operation>
		<operation>
			<search><![CDATA[?>]]></search>
			<add><![CDATA[function ModifySimpleSEFSettings($return_config = false)
{
	global $txt, $scripturl, $context, $settings, $sc, $modSettings, $boarddir, $sourcedir;

	$config_vars = array(
			array('check', 'simplesef_enable'),
			array('check', 'simplesef_simple'),
			array('text', 'simplesef_space', 6),
			array('text', 'simplesef_suffix'),
			array('check', 'simplesef_lowercase'),
			array('large_text', 'simplesef_strip_words', 6),
			array('large_text', 'simplesef_strip_chars', 6),
		'',
			$txt['simplesef_action_title'],
			array('text', 'simplesef_actions', 65),
			array('text', 'simplesef_useractions', 65),
	);

	if ($return_config)
		return $config_vars;

	$context['post_url'] = $scripturl . '?action=featuresettings2;save;sa=simplesef';
	$context['settings_title'] = $txt['simplesef'];

	// Saving?
	if (isset($_GET['save']))
	{
		if (trim($_POST['simplesef_suffix']) == '')
			fatal_lang_error('simplesef_suffix_required');

		$_POST['simplesef_suffix'] = trim($_POST['simplesef_suffix'], '.');

		$save_vars = $config_vars;

		// We don't want to break boards, so we'll make sure some stuff exists before actually enabling
		if (!empty($_POST['simplesef_enable']) && empty($modSettings['simplesef_enable']))
		{
			if (strpos($_SERVER['SERVER_SOFTWARE'], 'IIS') !== false && file_exists($boarddir . '/web.config'))
				$_POST['simplesef_enable'] = strpos(implode('', file($boarddir . '/web.config')), '<action type="Rewrite" url="index.php" />') !== false ? 1 : 0;
			elseif (strpos($_SERVER['SERVER_SOFTWARE'], 'IIS') === false && file_exists($boarddir . '/.htaccess'))
				$_POST['simplesef_enable'] = strpos(implode('', file($boarddir . '/.htaccess')), 'RewriteRule (.*) index.php') !== false ? 1 : 0;
			elseif (strpos($_SERVER['SERVER_SOFTWARE'], 'lighttpd') !== false)
				$_POST['simplesef_enable'] = 1;
			else
				$_POST['simplesef_enable'] = 0;
		}

		// Need to fudge a few things here to really enable/disable this baby
		$save_vars[] = array('text', 'integrate_pre_include');
		$_POST['integrate_pre_include'] = !empty($_POST['simplesef_enable']) ? $sourcedir . '/SimpleSEF.php' :  '';

		saveDBSettings($save_vars);

		redirectexit('action=featuresettings;sa=simplesef');
	}

	prepareDBSettingContext($config_vars);
}
]]></add>
		</operation>
	</file>
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[$txt['simplesef'] = 'SimpleSEF';
$txt['simplesef_desc'] = 'This section allows you to edit the options for SimpleSEF.<br /><br />
<strong>Note: If you enable this and start receiving 404 errors on your board, it is likely because .htaccess or web.config was not created, or your host does not have the mod_rewrite or Microsoft Url Rewrite module installed on the web server and you will not be able to use this mod.</strong> [<a href="#" onclick="showSimpleSEFHelp(); return false;">Help</a>]
<span style="display:block;" id="simplesef_help">If you have an Apache webserver, or one that uses .htaccess and has mod_rewrite functionality, you need a .htaccess file in your main SMF directory with the following:
<span style="display:block;" class="codeheader">Code:</span>
<code>RewriteEngine On<br />RewriteCond %{REQUEST_FILENAME} !-f<br />RewriteCond %{REQUEST_FILENAME} !-d<br />RewriteRule (.*) index.php</code>
<br />
If you have a IIS7 webserver, you need a web.config file in your main SMF directory with the following:
<span style="display:block;" class="codeheader">Code:</span>
<code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />&lt;configuration&gt;<br />    &lt;system.webServer&gt;<br />        &lt;rewrite&gt;<br />            &lt;rules&gt;<br />                &lt;rule name=&quot;SimpleSEF&quot;&gt;<br />                    &lt;match url=&quot;(.*)&quot; ignoreCase=&quot;false&quot; /&gt;<br />                    &lt;conditions logicalGrouping=&quot;MatchAll&quot;&gt;<br />                        &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsFile&quot; negate=&quot;true&quot; pattern=&quot;&quot; ignoreCase=&quot;false&quot; /&gt;<br />                        &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsDirectory&quot; negate=&quot;true&quot; pattern=&quot;&quot; ignoreCase=&quot;false&quot; /&gt;<br />                    &lt;/conditions&gt;<br />                    &lt;action type=&quot;Rewrite&quot; url=&quot;index.php&quot; /&gt;<br />                &lt;/rule&gt;<br />            &lt;/rules&gt;<br />        &lt;/rewrite&gt;<br />    &lt;/system.webServer&gt;<br />&lt;/configuration&gt;</code>
<br />
If you have Lighttpd v1.4.23 or less, you will need the following in your Lighttpd config file, normally at /etc/lighttpd/lighttpd.conf (thanks to <a href="http://www.simplemachines.org/community/index.php?action=profile;u=9547">Daniel15</a>).
<span style="display:block;" class="codeheader">Code:</span>
<code>$HTTP[&quot;host&quot;] =~ &quot;(www.)?example.com&quot; {<br />   url.rewrite-once += (<br />      # Allow all normal files<br />      &quot;^/forum/.*\.(js|ico|gif|jpg|png|swf|css|htm|php)(\?.*)?$&quot; =&gt; &quot;$0&quot;,<br />      # Rewrite everything else<br />      &quot;^/forum/.*$&quot; =&gt; &quot;/smf_2-0-rc2_sqlite/index.php&quot;<br />   )<br />}</code>
</span>
<script type="text/javascript"><!-- // --><!' . '[CDATA[
document.getElementById("simplesef_help").style.display = "none";
function showSimpleSEFHelp()
{
	document.getElementById("simplesef_help").style.display = "block";
}
// ]]' . '></script>';
$txt['simplesef_enable'] = 'Enable SimpleSEF<div class="smalltext">Requires mod_rewrite support or Url Rewrite/web.config (IIS7) support.</div>';
$txt['simplesef_simple'] = 'Create Simple URLs<div class="smalltext">Urls will look like /forum/board-1/, or /forum/topic-3.html instead of content filled.</div>';
$txt['simplesef_space'] = 'Space<div class="smalltext">Character to be used for spaces in the url.  Typically _ or -.</div>';
$txt['simplesef_suffix'] = 'Topic Extension<div class="smalltext">URL extension to use on topics (ie: html, php).</div>';
$txt['simplesef_suffix_required'] = 'An extension is required';
$txt['simplesef_strip_words'] = 'Words to strip<div class="smalltext">These are words that will be stripped out of urls.  This creates shorter, yet still readable urls.  The words you wish to strip should be seperated by a comma (no spaces).</div>';
$txt['simplesef_strip_chars'] = 'Characters to strip<div class="smalltext">These are characters that will be stripped out of urls.  This creates shorter, yet still readable urls.  The characters you wish to strip should be seperated by a comma (no spaces).</div>';
$txt['simplesef_lowercase'] = 'Lowercase URLs<div class="smalltext">Use this option to convert all urls to lower case letters.</div>';
$txt['simplesef_action_title'] = 'Actions<div class="smalltext">These are all of the actions of the board.  You normally do not need to edit this list.  Infact, if you do edit these lists, it can cause parts of your board not to function temporarily.  I provide this here only in case they must be edited in case something goes wrong.</div>';
$txt['simplesef_actions'] = 'Actions';
$txt['simplesef_subactions'] = 'Subactions';
$txt['simplesef_areas'] = 'Areas';
$txt['simplesef_adds'] = '<a href="http://www.mattzuba.com">SimpleSEF</a> adds';

]]></add>
		</operation>
	</file>
	<file name="$languagedir/Errors.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[$txt['simplesef_404'] = 'The page you requested could not be found.';
]]></add>
		</operation>
	</file>
</modification>
